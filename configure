#!/bin/bash
CXX_STD=CXX11
RCPP_INCLUDE_DIR=`${R_DIR}Rscript -e 'Rcpp:::CxxFlags()'`
RCPP_LIB_DIR=`${R_DIR}Rscript -e 'Rcpp:::LdFlags()'`
R_INCLUDE_DIR=`${R_DIR}R CMD config --cppflags`
R_LIB_DIR=`${R_DIR}R CMD config --ldflags`
ITKRCMAKE=`${R_DIR}Rscript -e 'a<-ITKR:::itkIncludes(); cat(a)'`
ITKRLIB=`${R_DIR}Rscript -e 'a<-ITKR:::itkLibs(); cat(a)'`
compflags=`${R_DIR}Rscript -e 'a<-ITKR:::itkCompileFlags(); cat(a)'`
# get a version of cmake
cmaker=`which cmake`
if [[ ! -x $cmaker ]] ; then # try r version
  cmaker=`${R_HOME}/bin/Rscript -e 'cmaker::cmake()'`
fi
JTHREADS=2
if [[ `uname` -eq Darwin ]] ; then
  CMAKE_BUILD_TYPE=Release
fi
if [[ $TRAVIS -eq true ]] ; then
  CMAKE_BUILD_TYPE=Release
  JTHREADS=2
fi
cd ./src
if [[ ! -s antb/Makefile  ]] ; then
  mkdir antb
  cd ./antb
  ${cmaker} -DITK_DIR:PATH=${ITKRCMAKE} \
    -DCMAKE_C_FLAGS="${CMAKE_C_FLAGS} ${compflags} -DNDEBUG  "\
    -DCMAKE_CXX_FLAGS="${CMAKE_CXX_FLAGS} ${compflags} -DNDEBUG  "\
    -DBUILD_SHARED_LIBS=OFF \
    -DBUILD_EXTERNAL_APPLICATIONS=OFF \
    -DBUILD_ALL_ANTS_APPS=OFF \
    -DUSE_SYSTEM_ITK=OFF \
    -DBUILD_TESTING=OFF \
    -DCMAKE_BUILD_TYPE:STRING="${CMAKE_BUILD_TYPE}"  ../ants
    # dont call make here ... this should be done elsewere
    # make -j $JTHREADS # | grep -v "Installing" | grep -v "Looking for"
  cd ../
#  for x in invariantImageSimilarity.cpp ../R/invariantImageSimilarity.R ../R/convolveImage.R ../man/convolveImage.Rd ../man/invariantImageSimilarity.Rd ; do
#    if [[ -s $x ]] ; then  rm $x; fi
#  done
fi
